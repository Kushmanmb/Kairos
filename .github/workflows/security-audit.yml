name: Security Audit

on:
  schedule:
    # Run every 2 hours
    - cron: '0 */2 * * *'
  workflow_dispatch:  # Allow manual triggers
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  security-audit:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run security audit on all directories
        run: |
          echo "=== Security Audit Starting ==="
          echo "Scanning all directories for security issues..."
          
          # Audit root directory
          echo "Auditing root directory..."
          python kairos.py
          KAIROS_EXIT_CODE=$?
          if [ "$KAIROS_EXIT_CODE" -ne 0 ]; then
            echo "Warning: kairos.py exited with code $KAIROS_EXIT_CODE during root directory audit."
          fi
          
          # Audit cosmosSDK directory
          echo "Auditing cosmosSDK directory..."
          python -m py_compile cosmosSDK/*.py
          
          echo "=== Security Audit Complete ==="
      
      - name: Run demo security response
        run: |
          echo "Testing security response systems..."
          python demo.py
      
      - name: Generate audit report
        run: |
          echo "=== Audit Report ===" > audit-report.txt
          echo "Timestamp: $(date)" >> audit-report.txt
          echo "Python Version: ${{ matrix.python-version }}" >> audit-report.txt
          echo "Repository: ${{ github.repository }}" >> audit-report.txt
          echo "Branch: ${{ github.ref }}" >> audit-report.txt
          echo "====================" >> audit-report.txt
          cat audit-report.txt
      
      - name: Upload audit report
        uses: actions/upload-artifact@v3
        with:
          name: audit-report-py${{ matrix.python-version }}
          path: audit-report.txt
          retention-days: 30
